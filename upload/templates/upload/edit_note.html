<head>
  {% load static %}

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.11.8/semantic.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.11.8/semantic.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
  <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

  <link rel="stylesheet" href="{% static 'css/main.css' %}"></script>
  <link rel="stylesheet" href="{% static 'css/jquery.Jcrop.min.css' %}"></script>
  <link rel="stylesheet" href="{% static 'css/demos.css' %}"></script>

  <script>
    var simplemde;
    var current=0;
    $(document).ready(function(){

        simplemde = new SimpleMDE({
            element: document.getElementById("MyID"),
            toolbar: ["bold", "italic", "heading", "|", "quote","preview","side-by-side","fullscreen",
                        {
                          name: "custom",
                          action: function (el) {
                            $("#myfile").trigger('click');
                          },
                          className: "fa fa-star",
                          title: "Custom Button",
                        },
             ],
        });
        $.each($(".edit .link-formset").children("input"),function(){
          var newv = $(this).val().replace(/(?:<br>)/g, '\r\n');
          $(this).val(newv);
          //console.log(newv+"\n");
        })
        simplemde.value($('#id_form-'+current+'-note').val()); //Initialize with list one content


        setInterval(function(){  $('#id_form-'+current+'-note').val(simplemde.value()); }, 500); //Autosave to hidden input

        $("#myfile").change(function () {

            var form= $('#file_upload').get(0);
            var formData = new FormData(form);

            $.ajax({
              url: '/upload/ajaxpic/',
              data: formData,
              type:'POST',
              contentType: false,
              processData: false,
              success: function (data) {
                  alert(data.uploaded_url);
                  pos = simplemde.codemirror.getCursor();
                  simplemde.codemirror.setSelection(pos, pos);
                  simplemde.codemirror.replaceSelection("![](http://127.0.0.1:8000"+data.uploaded_url+")");
              },
              error: function(data){
                console.log("Errorlog"+ data);
              }
            });
            form.reset();
          });

          $(".CodeMirror").on('click','img',function(){

          //  $('.modal #originalImg').css("display","inline-block");
            $('.modal').modal('show');
            $('.modal #originalImg').Jcrop({
                onChange: showCoords,
                onSelect: showCoords
            });
            $('.jcrop-holder img').attr("src",$(this).attr('src'));
            $('.modal #originalImg').attr("src",$(this).attr('src'));
            $('.modal #originalImg').attr("width",$(this).clientWidth);
            $('.modal #originalImg').attr("height",$(this).clientHeight);
            //$('.jcrop-holder img').attr("width",$(this).clientWidth);
            //$('.jcrop-holder img').attr("height",$(this).clientHeight);
            function showCoords(c)
            {
              jQuery('#x').val(c.x);
              jQuery('#y').val(c.y);
              jQuery('#width').val(c.w);
              jQuery('#height').val(c.h);
            };
          });


          $('#cropbtn').click(function(){

            var form= $('#photoform').get(0);
            var formData = new FormData(form);
            formData.append('file',$('.jcrop-holder img').attr('src'))
            $.ajax({
              url: '/upload/cropphoto/',
              data: formData,
              type:'POST',
              contentType: false,
              processData: false,
              success: function (data) {
                alert(data.file);
              }
            });

          })


          //  console.log($(".edit .link-formset").children("input").value());
          $(".edit").submit(function(){

            $.each($(".edit .link-formset").children("input"),function(){
              var newv = $(this).val().replace(/(?:\r\n|\r|\n)/g, '<br>');
              $(this).val(newv);
              //console.log(newv+"\n");
            })
            //console.log($(".edit .link-formset").children("input"));
          //  event.preventDefault();

          })


    });

    function change(index,classn)
    {
      $("#title").text(index);
      current = classn.charAt(5);
      simplemde.value($('#id_form-'+current+'-note').val());
      var newvalue = simplemde.value();
      console.log(newvalue.replace(/(?:\r\n|\r|\n)/g, '<br>'));
    }
  </script>

  <title>Site</title>
</head>
<body>

<!--Error file-->
  {% if messages %}
      {% for message in messages %}
          <p>{{ message }}</p>
      {% endfor %}
  {% endif %}

  {% if note_formset.non_field_errors %}
      <ul class='form-errors'>
          {% for field in note_formset %}
            {% for error in field.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          {% endfor %}
          {% for error in note_formset.non_field_errors %}
              <li>{{ error }}</li>
          {% endfor %}
      </ul>
  {% endif %}

<!--  Upload File -->

    <form method="post" enctype="multipart/form-data" id='file_upload'>
      {% csrf_token %}
      <input type="file" name="myfile" id="myfile" hidden>
    </form>



  <form action='' class="edit" method="post" enctype="multipart/form-data">
     {% csrf_token %}
     <!--List Area-->
    <div class="left" style="width:300px; display:inline-block;vertical-align:top;">
      <div class="ui ordered list" id='root'>
        {{ note_formset.management_form }}
        {% for link_form in note_formset %}
            <div class="link-formset">
              <div class="item one" id="list1">
                <a onclick="change($(this).children().val(), $(this).children().attr('name'))">{{ link_form.list_text }}</a>
              </div>
                {{ link_form.note }}
            </div>

        {% endfor %}
      </div>
    </div>
    <!--Editor Area-->
    <div class="right" style="width:600px; display:inline-block;">
        <H4 id='title'></h4>
          <textarea id="MyID" style="width:600px;" onchange="save();">
          </textarea>
    </div>
    <input type="submit" value="submit" class="button"/>
  </form>


  <!--Modal area-->
  <div class="ui modal">
    <div class="header">hahaha this is modal</div>
    <div class="content">
      <p>this is content</p>
      <img id="originalImg" src='' width="" height="">
      <button id="cropbtn">CropPhoto</button>
    </div>
  </div>

  <form action="" method="post" id="photoform">
    {% csrf_token %}
    <input   id="x" name="x" hidden />
    <input   id="y" name="y" hidden/>
    <input   id="width" name="width" hidden />
    <input   id="height" name="height" hidden/>
  </form>
  <!---->


  <script src="{% static 'js/add.js' %}"></script>
  <script src="{% static 'js/jquery.formset.js' %}"></script>
  <script src="{% static 'js/jquery.Jcrop.min.js' %}"></script>
  <script>
      $('.link-formset').formset({
          addText: 'add link',
          deleteText: 'remove'
      });


  </script>

</body>
